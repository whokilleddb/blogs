<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    <script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/light_dark.js"></script>
<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/tabs.js"></script>


<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/katex.min.js"></script>


<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/auto-render.min.js"></script>


<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/katex.js"></script>
<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/toc.js"></script>


    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="generator" content="Hugo 0.109.0">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>A gentle guide to the land of .NET, CLR and ETW &middot; </title>
    <meta name="description" content="" />

    
    <link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/poole.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/syntax.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/hyde.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/poison.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/fonts.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/katex.min.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/tabs.css">


    
    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5a5a5a;
        --link-color: #268bd2;
        --date-color: #515151;
        --code-color: #bf616a;
        --code-background-color: #f9f9f9;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #eee;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9d9d9d;
        --link-color: #268bd2;
        --date-color: #9a9a9a;
        --code-color: #ff7f7f;
        --code-background-color: #393D47;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="https://whokilleddb.github.io/blogs/">
                <img src="/blogs/images/avatar.png" alt="brand image">
            </a>
        
        
            <a href="https://whokilleddb.github.io/blogs/">
                <h1>db&#39;s bl0gs</h1>
            </a>
        
    </h1>
    <p class="lead">
    I am Batman
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">
        
        
        
        
            
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                        <li class="sub-heading">
                            Recent
                        </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/dotnet-clr-etw/">A gentle guide to the land of .NET, CLR and ETW</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/thm_gallery/">TryHackMe: Gallery</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/thm_dig_dug/">TryHackMe: Dig Dug</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/thm_agentt/">TryHackMe: Agentt</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/a_study_in_obfuscation/">A Study In Obfuscation</a>
                            </li>
                        
                    
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" href="https://github.com/whokilleddb">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>


    <a target="_blank" class="social" href="https://linkedin.com/whokilleddb">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>


    <a target="_blank" class="social" href="https://twitter.com/whokilleddb">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M5.032 14.286c6.037 0 9.34-4.837 9.34-9.032c0-.137 0-.274-.01-.41A6.56 6.56 0 0 0 16 3.2c-.6.256-1.235.425-1.885.5a3.207 3.207 0 0 0 1.443-1.757c-.645.37-1.35.63-2.085.77a3.322 3.322 0 0 0-1.862-.958a3.384 3.384 0 0 0-2.082.334a3.223 3.223 0 0 0-1.442 1.49a3.08 3.08 0 0 0-.208 2.03a9.57 9.57 0 0 1-3.747-.963a9.269 9.269 0 0 1-3.018-2.354a3.086 3.086 0 0 0-.36 2.314c.189.787.68 1.475 1.376 1.924a3.344 3.344 0 0 1-1.49-.398v.04c0 .734.263 1.444.743 2.01a3.3 3.3 0 0 0 1.89 1.102c-.483.128-.99.146-1.482.055a3.19 3.19 0 0 0 1.168 1.577a3.36 3.36 0 0 0 1.9.627A6.732 6.732 0 0 1 0 12.86a9.527 9.527 0 0 0 5.032 1.423"/>
        </svg>
    </a>



    <a target="_blank" class="social" href="https://tryhackme.com/">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24" >
            <path fill="white" d="M10.705 0C7.54 0 4.902 2.285 4.349 5.291a4.525 4.525 0 0 0-4.107 4.5 4.525 4.525 0 0 0 4.52 4.52h6.761a.625.625 0 1 0 0-1.25H4.761a3.273 3.273 0 0 1-3.27-3.27A3.273 3.273 0 0 1 6.59 7.08a.625.625 0 0 0 .7-1.035 4.488 4.488 0 0 0-1.68-.69 5.223 5.223 0 0 1 5.096-4.104 5.221 5.221 0 0 1 5.174 4.57 4.489 4.489 0 0 0-.488.305.625.625 0 1 0 .731 1.013 3.245 3.245 0 0 1 1.912-.616 3.278 3.278 0 0 1 3.203 2.61.625.625 0 0 0 1.225-.251 4.533 4.533 0 0 0-4.428-3.61 4.54 4.54 0 0 0-.958.105C16.556 2.328 13.9 0 10.705 0zm5.192 10.64a.925.925 0 0 0-.462.108.913.913 0 0 0-.313.29 1.27 1.27 0 0 0-.175.427 2.39 2.39 0 0 0-.054.514c0 .181.018.353.054.517.036.164.095.307.175.43a.899.899 0 0 0 .313.297c.127.073.281.11.462.11.18 0 .334-.037.46-.11a.897.897 0 0 0 .309-.296c.08-.124.137-.267.173-.431.036-.164.054-.336.054-.517 0-.18-.018-.352-.054-.514a1.271 1.271 0 0 0-.173-.426.901.901 0 0 0-.309-.291.917.917 0 0 0-.46-.108zm6.486 0a.925.925 0 0 0-.462.108.913.913 0 0 0-.313.29 1.27 1.27 0 0 0-.175.427 2.39 2.39 0 0 0-.053.514c0 .181.017.353.053.517.036.164.095.307.175.43a.899.899 0 0 0 .313.297c.127.073.281.11.462.11.18 0 .334-.037.46-.11a.897.897 0 0 0 .31-.296c.078-.124.136-.267.172-.431.036-.164.054-.336.054-.517 0-.18-.018-.352-.054-.514a1.271 1.271 0 0 0-.173-.426.901.901 0 0 0-.308-.291.916.916 0 0 0-.461-.108zm-8.537.068l-.84.618.313.43.476-.368v1.877h.603v-2.557zm6.486 0l-.841.618.314.43.477-.368v1.877h.603v-2.557zm-4.435.445c.08 0 .143.028.193.084.05.057.087.127.114.21.026.083.044.173.054.269a2.541 2.541 0 0 1 0 .533c-.01.097-.028.187-.054.27a.584.584 0 0 1-.114.21.243.243 0 0 1-.193.085.248.248 0 0 1-.195-.086.584.584 0 0 1-.118-.209 1.245 1.245 0 0 1-.056-.27 2.645 2.645 0 0 1 0-.533c.01-.096.029-.186.056-.27a.583.583 0 0 1 .118-.209.25.25 0 0 1 .195-.084zm6.486 0c.08 0 .144.028.193.084.05.057.087.127.114.21.027.083.044.173.054.269a2.541 2.541 0 0 1 0 .533c-.01.097-.027.187-.054.27a.584.584 0 0 1-.114.21.243.243 0 0 1-.193.085.249.249 0 0 1-.195-.086.581.581 0 0 1-.117-.209 1.245 1.245 0 0 1-.056-.27 2.642 2.642 0 0 1 0-.533c.01-.096.028-.186.056-.27a.58.58 0 0 1 .117-.209.25.25 0 0 1 .195-.084zm-2.191 3.51a.93.93 0 0 0-.463.109.908.908 0 0 0-.312.291c-.08.122-.139.263-.175.426a2.383 2.383 0 0 0-.054.514c0 .18.018.353.054.516.036.164.094.308.175.432a.91.91 0 0 0 .312.296.92.92 0 0 0 .463.11c.18 0 .333-.037.46-.11a.892.892 0 0 0 .308-.296 1.32 1.32 0 0 0 .174-.432c.036-.163.054-.335.054-.516 0-.18-.018-.352-.054-.514a1.274 1.274 0 0 0-.174-.426.89.89 0 0 0-.309-.291.918.918 0 0 0-.46-.108zm-6.402.07l-.841.617.314.43.476-.369v1.878h.604v-2.557zm2.125 0l-.841.617.314.43.477-.369v1.878h.603v-2.557zm2.116 0l-.84.617.313.43.477-.369v1.878h.603v-2.557zm2.16.443c.08 0 .144.028.194.085a.605.605 0 0 1 .114.21c.026.083.044.172.053.269a2.639 2.639 0 0 1 0 .532 1.28 1.28 0 0 1-.053.27.585.585 0 0 1-.114.21.244.244 0 0 1-.193.085.25.25 0 0 1-.196-.085.589.589 0 0 1-.117-.21 1.245 1.245 0 0 1-.056-.27 2.597 2.597 0 0 1 0-.532c.01-.097.028-.186.056-.27a.589.589 0 0 1 .117-.209.249.249 0 0 1 .196-.085zm-6.729 3.073a.676.676 0 0 0-.335.078.661.661 0 0 0-.227.211.91.91 0 0 0-.127.31c-.027.118-.04.242-.04.373s.013.256.04.375a.93.93 0 0 0 .127.313.65.65 0 0 0 .227.215c.092.053.204.08.335.08a.655.655 0 0 0 .334-.08.65.65 0 0 0 .225-.215c.057-.09.1-.194.125-.313a1.75 1.75 0 0 0 .04-.375c0-.13-.014-.255-.04-.373a.931.931 0 0 0-.125-.31.658.658 0 0 0-.225-.21.667.667 0 0 0-.334-.08zm3.086 0a.675.675 0 0 0-.336.078.661.661 0 0 0-.226.211.907.907 0 0 0-.127.31 1.69 1.69 0 0 0-.04.373c0 .131.013.256.04.375a.928.928 0 0 0 .127.313c.058.09.134.162.226.215.093.053.205.08.336.08a.655.655 0 0 0 .334-.08.65.65 0 0 0 .224-.215c.058-.09.1-.194.126-.313a1.752 1.752 0 0 0 0-.748.94.94 0 0 0-.126-.31.657.657 0 0 0-.224-.21.667.667 0 0 0-.334-.08zm5.108 0a.675.675 0 0 0-.336.078.661.661 0 0 0-.226.211.91.91 0 0 0-.127.31c-.027.118-.04.242-.04.373s.013.256.04.375a.931.931 0 0 0 .127.313c.058.09.134.162.226.215.093.053.205.08.336.08.13 0 .243-.027.334-.08a.65.65 0 0 0 .224-.215c.058-.09.1-.194.126-.313a1.75 1.75 0 0 0 .04-.375c0-.13-.014-.255-.04-.373a.943.943 0 0 0-.126-.31.657.657 0 0 0-.224-.21.668.668 0 0 0-.334-.08zm-6.658.05l-.61.448.227.311.346-.266v1.362h.438v-1.856zm3.068 0l-.61.448.227.311.346-.266v1.362h.438v-1.856zm5.108 0l-.611.448.228.311.346-.266v1.362h.438v-1.856zm-9.712.322c.058 0 .105.02.14.062a.421.421 0 0 1 .083.151.96.96 0 0 1 .04.196 1.932 1.932 0 0 1 0 .386.954.954 0 0 1-.04.197.421.421 0 0 1-.083.152.176.176 0 0 1-.14.061.18.18 0 0 1-.141-.06.427.427 0 0 1-.085-.153.887.887 0 0 1-.041-.197 1.96 1.96 0 0 1 0-.386.893.893 0 0 1 .04-.196.42.42 0 0 1 .086-.151.181.181 0 0 1 .141-.062zm3.086 0c.058 0 .104.02.14.062a.421.421 0 0 1 .082.151.94.94 0 0 1 .04.196 1.906 1.906 0 0 1 0 .386.93.93 0 0 1-.04.197.421.421 0 0 1-.082.152.176.176 0 0 1-.14.061.18.18 0 0 1-.141-.06.42.42 0 0 1-.086-.153.846.846 0 0 1-.04-.197 1.965 1.965 0 0 1-.011-.195c0-.057.004-.121.01-.191a.849.849 0 0 1 .041-.196.42.42 0 0 1 .086-.151.182.182 0 0 1 .141-.062zm5.108 0c.058 0 .104.02.14.062a.421.421 0 0 1 .082.151.92.92 0 0 1 .04.196 1.963 1.963 0 0 1 0 .386.943.943 0 0 1-.04.197.421.421 0 0 1-.082.152.177.177 0 0 1-.14.061.18.18 0 0 1-.142-.06.437.437 0 0 1-.085-.153.95.95 0 0 1-.04-.197 1.965 1.965 0 0 1-.011-.195c0-.057.004-.121.01-.191a.959.959 0 0 1 .04-.196.47.47 0 0 1 .086-.151.181.181 0 0 1 .142-.062zm-1.684 1.814a.675.675 0 0 0-.336.079.66.66 0 0 0-.227.21.91.91 0 0 0-.127.31 1.731 1.731 0 0 0 0 .748.939.939 0 0 0 .127.314c.059.09.134.162.227.215.093.053.205.08.336.08a.66.66 0 0 0 .334-.08.648.648 0 0 0 .224-.215c.058-.09.1-.195.126-.314a1.737 1.737 0 0 0-.001-.747.928.928 0 0 0-.125-.31.65.65 0 0 0-.224-.211.668.668 0 0 0-.334-.079zm3.063 0a.676.676 0 0 0-.336.079.664.664 0 0 0-.227.21.906.906 0 0 0-.127.31 1.74 1.74 0 0 0 0 .748.936.936 0 0 0 .127.314.66.66 0 0 0 .227.215c.092.053.204.08.336.08a.654.654 0 0 0 .334-.08.648.648 0 0 0 .223-.215c.058-.09.1-.195.126-.314a1.74 1.74 0 0 0 0-.747.928.928 0 0 0-.126-.31.65.65 0 0 0-.223-.211.666.666 0 0 0-.334-.079zm-1.545.05l-.611.448.228.312.346-.267v1.363h.438v-1.856zm-1.518.323c.057 0 .104.02.14.061a.42.42 0 0 1 .082.152.91.91 0 0 1 .04.195 1.966 1.966 0 0 1 0 .387.951.951 0 0 1-.04.197.421.421 0 0 1-.082.152.177.177 0 0 1-.14.06.18.18 0 0 1-.142-.06.428.428 0 0 1-.085-.152.914.914 0 0 1-.04-.197 1.96 1.96 0 0 1-.011-.195c0-.058.003-.122.01-.192a.923.923 0 0 1 .041-.195c.02-.06.048-.11.085-.152a.181.181 0 0 1 .142-.061zm3.063 0c.057 0 .104.02.14.061a.42.42 0 0 1 .082.152.94.94 0 0 1 .04.195 1.91 1.91 0 0 1 0 .387.93.93 0 0 1-.04.197.422.422 0 0 1-.083.152.175.175 0 0 1-.14.06.18.18 0 0 1-.141-.06.423.423 0 0 1-.085-.152.907.907 0 0 1-.04-.197 1.95 1.95 0 0 1 0-.387.915.915 0 0 1 .04-.195c.02-.06.048-.11.085-.152a.182.182 0 0 1 .142-.061zm-9.713.185a.465.465 0 0 0-.232.055.456.456 0 0 0-.157.146.627.627 0 0 0-.089.215 1.168 1.168 0 0 0-.027.259c0 .09.009.177.027.26a.648.648 0 0 0 .089.216c.04.063.093.112.157.149a.459.459 0 0 0 .232.056c.09 0 .168-.02.231-.056a.45.45 0 0 0 .156-.149.67.67 0 0 0 .087-.217 1.218 1.218 0 0 0 0-.518.647.647 0 0 0-.087-.215.448.448 0 0 0-.156-.146.458.458 0 0 0-.23-.055zm1.052.035l-.423.31.158.217.24-.185v.944h.303v-1.286zm-1.052.224c.04 0 .073.014.097.042a.284.284 0 0 1 .057.105.69.69 0 0 1 .028.136c.004.049.007.092.007.133 0 .04-.003.086-.007.135a.684.684 0 0 1-.028.136.285.285 0 0 1-.057.105.123.123 0 0 1-.097.043.125.125 0 0 1-.098-.043.298.298 0 0 1-.059-.105.612.612 0 0 1-.028-.136 1.39 1.39 0 0 1 0-.268.62.62 0 0 1 .028-.136.297.297 0 0 1 .06-.105.125.125 0 0 1 .097-.042zm3.775 1.394a.463.463 0 0 0-.232.054.452.452 0 0 0-.157.146.621.621 0 0 0-.088.214 1.19 1.19 0 0 0 0 .519.641.641 0 0 0 .088.217.46.46 0 0 0 .157.15.458.458 0 0 0 .232.054.454.454 0 0 0 .232-.055.45.45 0 0 0 .155-.149.664.664 0 0 0 .087-.217 1.189 1.189 0 0 0 0-.519.642.642 0 0 0-.087-.214.446.446 0 0 0-.155-.146.459.459 0 0 0-.232-.054zm1.052.034l-.423.31.158.216.24-.185v.945h.303V22.68zm-1.052.223c.04 0 .073.014.098.043a.3.3 0 0 1 .057.105.643.643 0 0 1 .027.135 1.31 1.31 0 0 1 0 .268.654.654 0 0 1-.027.137.307.307 0 0 1-.057.105.124.124 0 0 1-.098.042.125.125 0 0 1-.098-.042.293.293 0 0 1-.059-.105.618.618 0 0 1-.028-.137 1.364 1.364 0 0 1 0-.268.612.612 0 0 1 .028-.135.287.287 0 0 1 .06-.105.123.123 0 0 1 .097-.043z"></path>
        </svg>
    </a>




    <a target="_blank" class="social" href="https://instagram.com/whokilleddb">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9S287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7s74.7 33.5 74.7 74.7s-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8c-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8s26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9c-26.2-26.2-58-34.4-93.9-36.2c-37-2.1-147.9-2.1-184.9 0c-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9c1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0c35.9-1.7 67.7-9.9 93.9-36.2c26.2-26.2 34.4-58 36.2-93.9c2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6c-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6c-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6c29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6c11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/>
        </svg>
    </a>



        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2023 . All rights reserved.
</p>

  </div>
</aside>

        <main class="content container">
            <div class="post">
  <div class="info">
    <h1 class="post-title">
        <a href="https://whokilleddb.github.io/blogs/posts/dotnet-clr-etw/">A gentle guide to the land of .NET, CLR and ETW</a>
    </h1>
    <time datetime="2023-01-25T02:09:33&#43;0530" class="post-date">
        January 25, 2023
    </time>
    
    
    
    
    
    
</div>

  <h2 id="rant-as-an-introduction">Rant as an Introduction</h2>
<p>When initially getting into ETW and patching it, I was not prepared for what was coming. It was a deep rabbit hole of <code>.NET</code>, <code>CLR</code> and <code>Windows Internals</code>. Coming from a pure-<code>C</code> background(and a bit of <code>Rust</code>), this was a deep hole I was not prepared for at all. This blog is supposed to be more of a Journal than a tutorial as I try to figure things out! So, if you are someone who is as lost as I am, with Zero knowledge of the <code>.NET Framework</code> or any of the <code>C#</code> stuff and want to go around patching stuff, welcome to the journey.</p>
<p>*PS: There will be a scramble of topics in no particular order, mostly discussing topics relevant to the cause. The contents of this blog post, including all source code can be found <a href="https://github.com/whokilleddb/etw-patching-for-dummies">here</a> *</p>
<h2 id="show-and-tell---the-net-framework">Show and Tell - The .NET FRAMEWORK</h2>
<p>So, when I started writing this blog, I had no idea what <code>.NET</code> really was. All knew was that its <em>some-sorta</em> framework by Microsoft for doing windows stuff. Turns out, it is a framework for <code>C#</code> and a version of <code>C++</code> called <code>C++/CLI</code>, which can be compiled with <code>Visual C++</code> on Windows. Here, my first question was, <em>&ldquo;Hey, then how is it different from normal C++ code?&rdquo;</em></p>
<p>And to solve that question, I decided to do what all good devs would have done: write a <em>&ldquo;Hello World&rdquo;</em> program in both styles.</p>
<p><strong>Native C++</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// helloworld.cpp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;thread&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;chrono&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Hello, World!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>this_thread<span style="color:#f92672">::</span>sleep_for(std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>seconds(<span style="color:#ae81ff">100</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>C++/CLI</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// helloworld_cli.cpp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#using &lt;mscorlib.dll&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> System<span style="color:#f92672">::</span>Threading;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>  Console<span style="color:#f92672">::</span>WriteLine(<span style="color:#e6db74">&#34;Hello, World!&#34;</span>);
</span></span><span style="display:flex;"><span>  Thread<span style="color:#f92672">::</span>Sleep(<span style="color:#ae81ff">100000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Both of these can be compiled with <code>cl.exe</code> aka the <code>Visual Studio Compiler</code> as such:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>&gt; cl.exe helloworld.cpp /EHsc
</span></span><span style="display:flex;"><span>&gt; cl.exe helloworld_cli.cpp /clr
</span></span></code></pre></div><p>This should give us two binaries: <code>helloworld.exe</code> and <code>helloworld_cli.exe</code>, both of which print the same <code>&quot;Hello, World!&quot;</code> statement and then go to sleep. The sleep part is there to give us enough time to examine the process.</p>
<p>The first thing which I noticed was that the <code>C++/CLI</code> excutable was much smaller than the native <code>C++</code> executable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>10-01-2023  15:19           242,688 helloworld.exe
</span></span><span style="display:flex;"><span>10-01-2023  04:49            32,256 helloworld_cli.exe
</span></span></code></pre></div><p>This is becase when you compile a C++/CLI program, the resulting executable is actually a combination of native machine code and <code>managed code</code>.</p>
<p><code>Managed code</code> is code that runs under the control of the <code>.NET</code> runtime, which provides a number of services such as memory management, exception handling, and type safety (we would talk more about this later). Because the runtime provides these services, managed code does not need to include the same kind of infrastructure that is required for native code.</p>
<p>As a result, <code>C++/CLI</code> executables are typically smaller in size than native <code>C++</code> executables. This is because they don&rsquo;t need to include memory management, exception handling and other related implementations themselves, which are provided by the runtime.</p>
<p>Additionally, C++/CLI codes makes use of the <code>CLR</code> (another thing we would get to later) which is a part of the <code>.NET</code> Framework, this framework ships with the operating system, as such <code>C++/CLI</code> application does not require any additional runtime or library dependencies.</p>
<p>Looking at each process in <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer">Process Explorer</a>, we see the following:</p>
<p><img src="/blogs/images/etw-patching-for-dummies/helloworld_process_explorer.png" alt=""></p>
<p><img src="/blogs/images/etw-patching-for-dummies/helloworld_cli_process_explorer.png" alt=""></p>
<p>The first thing I noticed was that the <code>C++/CLI</code> executable has two extra tabs:</p>
<ul>
<li>
<p><code>.NET Assemblies</code> - This feature allows you to view the <code>.NET</code> assemblies that are loaded in a specific process. The tab displays information such as the assembly name, version, and location, as well as the classes and methods that are present in each assembly. This information can be helpful for troubleshooting issues with <code>.NET</code> applications, as well as for understanding the internal workings of a process.</p>
</li>
<li>
<p><code>.NET Performance</code> - This feature allows you to view performance statistics for the <code>.NET Framework</code> in a specific process. The tab displays information such as the number of <code>.NET</code> objects and exceptions, the number of GC collections, the amount of memory allocated, and the CPU time consumed by the <code>.NET</code> runtime. This tab also allows you to view performance counter metrics for the <code>CLR</code> such as the number of bytes in all heaps and the current number of Gen 0, 1 and 2 collections. This information can be helpful for diagnosing performance issues in <code>.NET</code> applications, such as high memory usage or poor garbage collection behavior.</p>
</li>
</ul>
<p>Only the first one is of interest to us for now. The tab contains the following information:
<img src="/blogs/images/etw-patching-for-dummies/dotnet_assemblies_tab.png" alt=""></p>
<p>First things first, notice the <code>CLR</code> version. We will talk about <code>CLR</code> later either ways. Next up, notice the flag values adjacent to the <code>helloworld_cli.exe</code> name. The <code>CONCURRENT_GC</code> means that the garbage collector runs concurrently with the application, which can help to reduce the amount of time that the application is paused while the garbage collector is running. Next comes the <code>ManagedExe</code> flag which signifies that the executable runs using the <code>CLR</code>. Another interesting word which keeps popping is <code>AppDomain</code>.</p>
<blockquote>
<p>An AppDomain, short for Application Domain, is a lightweight and isolated execution environment within a process in the .NET Framework. It allows multiple applications to run within a single process while maintaining isolation and security between them.</p>
</blockquote>
<p>So, it&rsquo;s like a logical isolation. I like to think of it to be loosely akin to Linux <code>namespaces</code> but more dotnet-y. Moving on, we see another <code>AppDomain</code> by the name of <code>SharedDomain</code> in there with <code>mscorlib.dll</code>. I really like <a href="http://www.danielmoth.com/Blog/mscorlibdll.aspx">The Moth&rsquo;s Explanation</a> of the name: ms(Microsoft)-cor(Common Object Runtime)-lib(Library) [yeah yeah its ms stands for multilingual standard now, but the original name makes more sense].  According to <a href="https://social.msdn.microsoft.com/Forums/vstudio/en-US/92a0c975-e350-4d8d-af8e-36ec0ad6c95c/specific-purpose-of-mscorlib-dll-in-net?forum=clr">this thread</a> on microsoft&rsquo;s forums, this library contains the various namespace defintitions (so, much like kernel32/ntdll for normal programs?).</p>
<p><img src="/blogs/images/etw-patching-for-dummies/mscorlib_dotpeek.png" alt=""></p>
<p>I believe this is a good introduction to the land of <code>.NET</code>, but before we talk further, we need to discuss about <code>CLR</code> and <code>Managed Code</code>.</p>
<h2 id="the-clr-common-language-runtime">The CLR: Common Language Runtime</h2>
<p>The <code>CLR</code> is the Virtual Machine component of the <code>.NET Framework</code>. It is  responsible for executing <code>Managed</code> code. It provides a layer of abstraction between the application and the operating system, allowing the application to run in a more secure and stable environment. The <code>CLR</code> also provides a number of services to the application, such as memory management, thread execution, security, and code execution.</p>
<p>One of the more important components which the <code>CLR</code> contains is a JIT compiler which is responsible for converting <code>MSIL</code> (Microsoft Intermediate Language) code, which is the intermediate language generated by the compiler when the source code of a <code>.NET</code> application is compiled, into native machine code that can be executed by the computer&rsquo;s hardware.</p>
<h2 id="msil---a-short-note">MSIL - A Short Note</h2>
<p><code>MSIL</code> (Microsoft Intermediate Language) is a low-level programming language used in the <code>.NET Framework</code>. It is an intermediate language between the source code of a program and the machine code that is executed by the computer.</p>
<p>When a <code>.NET</code> application is compiled, the source code written in languages such as <code>C#</code> or Visual Basic is transformed into <code>MSIL</code>. <code>MSIL</code> is a platform-independent language, meaning that the same <code>MSIL</code> code can be executed on different platforms and architectures, such as Windows, Linux, or macOS, as long as the <code>.NET Framework</code> is installed.</p>
<p><code>MSIL</code> contains instructions that are executed by the <code>CLR</code> (Common Language Runtime) at runtime, rather than being executed directly by the computer&rsquo;s hardware. This allows the <code>CLR</code> to provide sservices, such as memory management, security, and code execution, to the application.</p>
<p><code>MSIL</code> also contains metadata, which is data about the types, members, and other elements in the code. The metadata is used by the <code>CLR</code> to determine the types and members that are used by the application, to resolve dependencies, and to enforce security policies.</p>
<p>It&rsquo;s important to note that, <code>MSIL</code> code is not executed directly by the hardware, instead it is compiled to native code at runtime by the JIT (Just-In-Time) compiler, which is a component of the <code>CLR</code>. This allows the code to be optimized for the specific hardware and operating system that it is running on, which results in more efficient execution.</p>
<h2 id="managed-code">Managed Code</h2>
<p>Managed code in the .NET Framework refers to code that is executed by the Common Language Runtime (<code>CLR</code>) rather than directly by the computer&rsquo;s hardware. <code>Managed code</code> is written in a managed programming language, such as <code>C#</code> or <code>Visual Basic</code>, and it is compiled into an intermediate language called Microsoft Intermediate Language (MSIL). MSIL is a low-level programming language that is executed by the CLR at runtime, rather than being executed directly by the computer&rsquo;s hardware.</p>
<hr>
<p>OOkay,that was a lot of theory. Long story short, <code>.NET</code> code requires the <code>CLR</code> to run the <code>MSIL</code>, hence it is <em>&ldquo;managed&rdquo;</em>. NNow,here comes the next big question: <strong>&ldquo;Can we call managed code from an unmanaged process?&rdquo;</strong>. Well, turns out we can, but for that we need to manually load <code>CLR</code> into the process. Taking a page out of <a href="https://blog.xpnsec.com/hiding-your-dotnet-etw/">Adam Chester&rsquo;s Blog</a> we can write some code to load a <code>CLR</code> instance into an unmanaged process and call managed code from there.
The code can be found <a href="https://github.com/whokilleddb/load-my-clr">here</a>. LLet&rsquo;sbreak it down.</p>
<p>There are four primary wrapper functions:</p>
<ul>
<li><code>GetCLRInterface</code></li>
<li><code>StartRuntime</code></li>
<li><code>RunAssembly</code></li>
<li><code>StopRuntime</code></li>
</ul>
<p>These functions load the <code>CLR</code> into our unmanaged process, start the runtime, run the <code>.NET</code> code and then finally stop the runtime.</p>
<h3 id="getclrinterface"><code>GetCLRInterface</code></h3>
<p>First, we create an a instance of the type <code>ICLRMetaHost</code> by calling the following the <code>CLRCreateInstance()</code> function as such:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>result <span style="color:#f92672">=</span> <span style="color:#a6e22e">CLRCreateInstance</span>(<span style="color:#f92672">&amp;</span>CLSID_CLRMetaHost, <span style="color:#f92672">&amp;</span>IID_ICLRMetaHost, (LPVOID<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>metahost);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (result <span style="color:#f92672">!=</span> S_OK){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] CLRCreateInstance() function failed (0x%x)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, result);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This provides us with a <code>ICLRMetaHost</code> Interface which we can use to perfeorm a multitude of tasks like return a specific version of the common language runtime (CLR) based on its version number, list all installed CLRs, list all runtimes that are loaded in a specified process, discover the CLR version used to compile an assembly, exit a process with a clean runtime shutdown, and query legacy API binding, etc. Refer the official <a href="https://learn.microsoft.com/en-us/dotnet/framework/unmanaged-api/hosting/iclrmetahost-interface#methods">docs</a> here!</p>
<p>Once we have our interface, we can use it to enumerate all installed Runtimes wth:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>result <span style="color:#f92672">=</span> <span style="color:#a6e22e">ICLRMetaHost_EnumerateInstalledRuntimes</span>(metahost, <span style="color:#f92672">&amp;</span>runtime);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (result <span style="color:#f92672">!=</span> S_OK){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] EnumerateInstalledRuntimes() function failed (0x%x)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, result);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This returns an enumeration that contains a valid <a href="https://learn.microsoft.com/en-us/dotnet/framework/unmanaged-api/hosting/iclrruntimeinfo-interface">ICLRRuntimeInfo</a> interface for each version of the common language runtime (CLR) that is installed on a computer. We can go through these entries and list all the available versions with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">while</span>((result <span style="color:#f92672">=</span> <span style="color:#a6e22e">IEnumUnknown_Next</span>(runtime, <span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>unk, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> S_OK){
</span></span><span style="display:flex;"><span>  result <span style="color:#f92672">=</span> <span style="color:#a6e22e">IUnknown_QueryInterface</span>(unk, <span style="color:#f92672">&amp;</span>IID_ICLRRuntimeInfo, (<span style="color:#66d9ef">void</span><span style="color:#f92672">**</span>)<span style="color:#f92672">&amp;</span>runtimeinfo);
</span></span><span style="display:flex;"><span>  count <span style="color:#f92672">=</span> MAX_PATH;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> S_OK){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Get Version String
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    result <span style="color:#f92672">=</span> <span style="color:#a6e22e">ICLRRuntimeInfo_GetVersionString</span>(runtimeinfo, buf, <span style="color:#f92672">&amp;</span>count);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> S_OK <span style="color:#f92672">&amp;&amp;</span> count <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">wprintf</span>(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;[i] Found Runtime Version: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] ICLRRuntimeInfo_GetVersionString() Failed (0x%x)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, result);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">IUnknown_Release</span>(unk);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This should list all the available versions of the <code>CLR</code> to us. We just go for the last available version and if it can be loaded into the current system, we are good to go:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Get last supported runtime
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>result <span style="color:#f92672">=</span> <span style="color:#a6e22e">ICLRRuntimeInfo_GetInterface</span>(runtimeinfo, <span style="color:#f92672">&amp;</span>CLSID_CLRRuntimeHost, <span style="color:#f92672">&amp;</span>IID_ICLRRuntimeHost, (LPVOID<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>runtimehost);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (result <span style="color:#f92672">!=</span> S_OK){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] ICLRRuntimeInfo_GetInterface() function failed (0x%x)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, result);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Check runtime host
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (count <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> NULL <span style="color:#f92672">==</span> runtimehost){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] No Valid Runtime Found</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> OLEOBJ_S_INVALIDHWND;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If this is all good to go, we can then move onto the next step of the process, which is to actually start the <code>CLR</code>  into our current process.</p>
<h3 id="startruntime"><code>StartRuntime</code></h3>
<p>This function is essentially a wrapper around the <code>ICLRRuntimeHost_Start</code> function, which is used to start the execution of the <code>CLR</code> in a process. It initializes the <code>CLR</code> and sets up the infrastructure needed for managed code execution. Once the <code>CLR</code> is started, it allows the process to load and execute assemblies that contain managed code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[i] Starting Runtime</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> <span style="color:#a6e22e">ICLRRuntimeHost_Start</span>(runtimehost);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (result <span style="color:#f92672">!=</span> S_OK){
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] ICLRRuntimeHost_Start() function failed (0x%x)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, result);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This loads the <code>CLR</code> into our current process and at this point, we are good to run some managed code!</p>
<h3 id="runassembly"><code>RunAssembly</code></h3>
<p>This is the part where we finally the run managed code with the <code>ICLRRuntimeHost_ExecuteInDefaultAppDomain</code> function. It takes in the path to the assembly, the name of the type in the format <code>Namespace.Class</code>, the name of the method to invoke, the string parameter to pass to the program and  variable to store the return code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>result <span style="color:#f92672">=</span> <span style="color:#a6e22e">ICLRRuntimeHost_ExecuteInDefaultAppDomain</span>(runtimehost, assembly_path, namespace_class, function_name, cmd_arguments, <span style="color:#f92672">&amp;</span>res);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (result <span style="color:#f92672">!=</span> S_OK){
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] ICLRRuntimeHost_ExecuteInDefaultAppDomain() function failed (0x%x)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, result);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (result<span style="color:#f92672">==</span><span style="color:#ae81ff">0x80070002</span>){
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] The speicified .NET assembly could not be found</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In our example, we invoke a very simple <code>MessageBox</code> program which displays the message we supplied as argument input as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">RunAssembly</span>(
</span></span><span style="display:flex;"><span>PROGRAM_PATH,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;HelloWorld.Program&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;EntryPoint&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;Hello There (General Kenobi)&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><img src="/blogs/images/etw-patching-for-dummies/poc.png" alt=""></p>
<h3 id="stopruntime"><code>StopRuntime</code></h3>
<p>Finally, we use stop the execution of the code with the <code>ICLRRuntimeHost_Stop</code> method call.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>result <span style="color:#f92672">=</span> <span style="color:#a6e22e">ICLRRuntimeHost_Stop</span>(runtimehost);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (result <span style="color:#f92672">!=</span> S_OK){
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] ICLRRuntimeHost_Stop() function failed (0x%x)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, result);\
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Finally, when everything is done, we call the <code>CleanUp</code> function and make sure we have released all the globals!</p>
<hr>
<p>One very interesting thing I noticed was if I open the process in <code>ProcessHacker</code>, right before the <code>CLR</code> runtime is started with the <code>ICLRRuntimeHost_Start()</code> function, the <code>.NET</code> tabs do not appear. However, as soon as the <code>CLR</code> host is up and running, the <code>.NET</code> tabs reappear again. <em>Interesting&hellip;&hellip;</em></p>
<p><img src="/blogs/images/etw-patching-for-dummies/loader_under_process_hacker.png" alt="">
One gaping problem in this project is that using this particular approach, we need the managed code to be run on the disk itself. A better way to do things would be to run things in-memory, but that&rsquo;s a problem for another time.</p>
<h2 id="etw-what-the-hell-is-even-that">ETW: What the hell is even that?</h2>
<p>According to <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/event-tracing-for-windows--etw-">MSDN docs</a>, <code>ETW</code> can be defined as:</p>
<blockquote>
<p><code>Event Tracing for Windows</code> (<code>ETW</code>) provides a mechanism to trace and log events that are raised by user-mode applications and kernel-mode drivers. <code>ETW</code> is implemented in the Windows operating system and provides developers a fast, reliable, and versatile set of event tracing features.</p>
</blockquote>
<p><code>ETW</code> has three components to it:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/etw/about-event-tracing#controllers">Controllers</a>, which start and stop an event tracing session and enable providers</li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/etw/about-event-tracing#providers">Providers</a>, which provide the events</li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/etw/about-event-tracing#consumers">Consumers</a>, which consume the events</li>
</ul>
<p>As red teamers, we are only concerned with the <code>Consumers</code> of <code>ETW</code>  log events. It is because often EDRs and AV engines act as consumer agents and analyze the events generated from various <code>Providers</code> to look for sus processes/events.</p>
<p>One thing to keep in mind is that <code>ETW</code> is a kernel mode mechanism, unlike <code>AMSI</code> which dwells in userland. <code>ETW</code> consumers are now integrated into many EDR endpoint agents in order to receive <code>CLR</code> Runtime traces. Some of the providers which might reveal the secrets of your malicious <code>.NET</code> assemblies are:</p>
<ul>
<li>Microsoft-Windows-COMRuntime</li>
<li>Microsoft-Windows-DotNETRuntime</li>
<li>Microsoft-Windows-DotNETRuntimeRundown</li>
</ul>
<p>Infact, you can list all the providers on your system with:</p>
<pre tabindex="0"><code>logman query providers
</code></pre><p><img src="/blogs/images/etw-patching-for-dummies/listing_all_providers.png" alt=""></p>
<p>Infact, we can write our own consumers, as you fill find <a href="https://github.com/whokilleddb/etw-patching-for-dummies">here</a> where you can monitor the logs generated by a process from a specific provider (there is a big list of providers in the <code>includes/providers.h</code> file so remember to swap out line <code>131</code> in <code>src/consumer.c</code> as I am too lazy to write a cli implementation just yet).</p>
<p>Now the question is, how do we get around <code>ETW</code>? We cant let the defender know that red teamers are on the system, therefore, it&rsquo;s time to patch things up!</p>
<h2 id="patching-etw">Patching ETW</h2>
<p>For the basics of ETW patching, I really recommend going through <a href="https://www.mdsec.co.uk/2020/03/hiding-your-net-etw/">Adam Chester&rsquo;s Blog</a> which talks about patching the <a href="https://learn.microsoft.com/en-us/windows/win32/devnotes/etweventwrite">EtwEventWrite</a> function. However, for our intents and purpose, we would be referring to this <a href="https://whiteknightlabs.com/2021/12/11/bypassing-etw-for-fun-and-profit/">Whiteknight Blog</a> which goes one level deeper and patches the  <code>NtTraceEvent</code> syscall used by a lot of the logging utilities.</p>
<p>The idea is to patch the <code>NtTraceEvent</code> function to return a value of 0 (<code>STATUS_SUCCESS</code>) indicates that the call was successful and the requested operation was completed. We overwrite the beginning of the function with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">xor</span> <span style="color:#66d9ef">rax</span>, <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ret</span>
</span></span></code></pre></div><p>You can add a <code>nop</code> sled just for the ✨razzle-dazzle✨ but overall this should cause the intended value to be returned to the caller without actually issuing the syscall to the kernel, indicating to the caller that the syscall was successful. A quick and dirty skeletal code to patch <code>NtTraceEvent</code> can be written as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>DWORD _temp, oldprotect <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> patch_bytes[] <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0x90</span>, <span style="color:#ae81ff">0x90</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xC0</span>, <span style="color:#ae81ff">0xC3</span> };
</span></span><span style="display:flex;"><span>FARPROC nt_trace_event_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetProcAddress</span>(<span style="color:#a6e22e">LoadLibrary</span>(<span style="color:#e6db74">&#34;ntdll&#34;</span>), <span style="color:#e6db74">&#34;NtTraceEvent&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">VirtualProtect</span>((LPVOID)nt_trace_event_addr, <span style="color:#66d9ef">sizeof</span>(patch_bytes), PAGE_EXECUTE_READWRITE, <span style="color:#f92672">&amp;</span>oldprotect);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(nt_trace_event_addr, patch_bytes, <span style="color:#66d9ef">sizeof</span>(patch_bytes));
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">VirtualProtect</span>((LPVOID)nt_trace_event_addr, <span style="color:#66d9ef">sizeof</span>(patch_bytes), oldprotect, <span style="color:#f92672">&amp;</span>_temp);
</span></span></code></pre></div><p>A small hiccup which I faced during the this while drawing a parallels with <code>AMSI</code> patching is that back during patching <code>AMSI</code>, I could set the memory protection with <code>VirtualProtect()</code> as <code>PAGE_READWRITE</code> but doing so here somehow crashes the program with the error code <code>0xC0000005</code> aka <code>STATUS_ACCESS_VIOLATION</code> which I believe is protected (afterall, its a syscall) and needs to be executable and readable!</p>
<p>Apart from that we should be easily able to patch things up. The <code>patcher.c</code> program has a more refined version of the PoC code and once compiled, we can use <code>WinDbg</code> to see the syscall being patched in real time.</p>
<p><img src="/blogs/images/etw-patching-for-dummies/patched_etw.png" alt=""></p>
<p>Thus, we successfully patched ETW at a syscall level. ETW patching is just one of the many things you can do to blind EDRs. As a begineer, I wanted to understand how <code>C#</code>, <code>.NET</code> and <code>ETW</code> all come in together in thw Windows landscape, and how we as red teamers can be one step ahead at all times.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.mdsec.co.uk/2020/03/hiding-your-net-etw/">Hiding Your .NET – ETW</a></li>
<li><a href="https://www.cobaltstrike.com/blog/cobalt-strike-3-11-the-snake-that-eats-its-tail/">Cobalt Strike 3.11 – The snake that eats its tail</a></li>
<li><a href="https://mez0.cc/posts/common-language-runtime-1">Common Language Runtime #1: An Introduction</a></li>
<li><a href="https://www.youtube.com/watch?v=3WJ1mRGP4So">Role of Common Language Runtime(CLR) in .NET Framework - .NET Technology Lectures</a></li>
</ul>

  <hr>
<div class="footer">
    
	    
            
	            <a class="previous-post" href="https://whokilleddb.github.io/blogs/posts/thm_gallery/?ref=footer">« TryHackMe: Gallery</a>
	        
        
	    
    
</div>

  <div class="article-toc " >
    <h4></h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#rant-as-an-introduction">Rant as an Introduction</a></li>
    <li><a href="#show-and-tell---the-net-framework">Show and Tell - The .NET FRAMEWORK</a></li>
    <li><a href="#the-clr-common-language-runtime">The CLR: Common Language Runtime</a></li>
    <li><a href="#msil---a-short-note">MSIL - A Short Note</a></li>
    <li><a href="#managed-code">Managed Code</a>
      <ul>
        <li><a href="#getclrinterface"><code>GetCLRInterface</code></a></li>
        <li><a href="#startruntime"><code>StartRuntime</code></a></li>
        <li><a href="#runassembly"><code>RunAssembly</code></a></li>
        <li><a href="#stopruntime"><code>StopRuntime</code></a></li>
      </ul>
    </li>
    <li><a href="#etw-what-the-hell-is-even-that">ETW: What the hell is even that?</a></li>
    <li><a href="#patching-etw">Patching ETW</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
</div>

</div>
        </main>
    </body>
</html>
