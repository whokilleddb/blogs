<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    <script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/light_dark.js"></script>
<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/tabs.js"></script>


<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/katex.min.js"></script>


<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/auto-render.min.js"></script>


<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/katex.js"></script>
<script defer language="javascript" type="text/javascript" src="https://whokilleddb.github.io/blogs/js/toc.js"></script>


    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="generator" content="Hugo 0.111.3">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Heaven&#39;s Gate and the tale of Segments &middot; </title>
    <meta name="description" content="" />

    
    <link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/poole.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/syntax.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/hyde.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/poison.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/fonts.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/katex.min.css">
<link type="text/css" rel="stylesheet" href="https://whokilleddb.github.io/blogs/css/tabs.css">


    
    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5a5a5a;
        --link-color: #268bd2;
        --date-color: #515151;
        --code-color: #bf616a;
        --code-background-color: #f9f9f9;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #eee;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9d9d9d;
        --link-color: #268bd2;
        --date-color: #9a9a9a;
        --code-color: #ff7f7f;
        --code-background-color: #393D47;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="https://whokilleddb.github.io/blogs/">
                <img src="/blogs/images/avatar.png" alt="brand image">
            </a>
        
        
            <a href="https://whokilleddb.github.io/blogs/">
                <h1>db&#39;s bl0gs</h1>
            </a>
        
    </h1>
    <p class="lead">
    I am Batman
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">
        
        
        
        
            
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                        <li class="sub-heading">
                            Recent
                        </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/heavens-gate-and-the-tale-of-segments/">Heaven&#39;s Gate and the tale of Segments</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/uefi-jungle/">UEFI Jungle</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/process-ghosting/">Process Ghosting</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/dotnet-clr-etw/">A gentle guide to the land of .NET, CLR and ETW</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://whokilleddb.github.io/blogs/posts/thm_gallery/">TryHackMe: Gallery</a>
                            </li>
                        
                    
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" href="https://github.com/whokilleddb">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>


    <a target="_blank" class="social" href="https://www.linkedin.com/in/whokilleddb/">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>


    <a target="_blank" class="social" href="https://twitter.com/whokilleddb">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M5.032 14.286c6.037 0 9.34-4.837 9.34-9.032c0-.137 0-.274-.01-.41A6.56 6.56 0 0 0 16 3.2c-.6.256-1.235.425-1.885.5a3.207 3.207 0 0 0 1.443-1.757c-.645.37-1.35.63-2.085.77a3.322 3.322 0 0 0-1.862-.958a3.384 3.384 0 0 0-2.082.334a3.223 3.223 0 0 0-1.442 1.49a3.08 3.08 0 0 0-.208 2.03a9.57 9.57 0 0 1-3.747-.963a9.269 9.269 0 0 1-3.018-2.354a3.086 3.086 0 0 0-.36 2.314c.189.787.68 1.475 1.376 1.924a3.344 3.344 0 0 1-1.49-.398v.04c0 .734.263 1.444.743 2.01a3.3 3.3 0 0 0 1.89 1.102c-.483.128-.99.146-1.482.055a3.19 3.19 0 0 0 1.168 1.577a3.36 3.36 0 0 0 1.9.627A6.732 6.732 0 0 1 0 12.86a9.527 9.527 0 0 0 5.032 1.423"/>
        </svg>
    </a>



    <a target="_blank" class="social" href="https://tryhackme.com/">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24" >
            <path fill="white" d="M10.705 0C7.54 0 4.902 2.285 4.349 5.291a4.525 4.525 0 0 0-4.107 4.5 4.525 4.525 0 0 0 4.52 4.52h6.761a.625.625 0 1 0 0-1.25H4.761a3.273 3.273 0 0 1-3.27-3.27A3.273 3.273 0 0 1 6.59 7.08a.625.625 0 0 0 .7-1.035 4.488 4.488 0 0 0-1.68-.69 5.223 5.223 0 0 1 5.096-4.104 5.221 5.221 0 0 1 5.174 4.57 4.489 4.489 0 0 0-.488.305.625.625 0 1 0 .731 1.013 3.245 3.245 0 0 1 1.912-.616 3.278 3.278 0 0 1 3.203 2.61.625.625 0 0 0 1.225-.251 4.533 4.533 0 0 0-4.428-3.61 4.54 4.54 0 0 0-.958.105C16.556 2.328 13.9 0 10.705 0zm5.192 10.64a.925.925 0 0 0-.462.108.913.913 0 0 0-.313.29 1.27 1.27 0 0 0-.175.427 2.39 2.39 0 0 0-.054.514c0 .181.018.353.054.517.036.164.095.307.175.43a.899.899 0 0 0 .313.297c.127.073.281.11.462.11.18 0 .334-.037.46-.11a.897.897 0 0 0 .309-.296c.08-.124.137-.267.173-.431.036-.164.054-.336.054-.517 0-.18-.018-.352-.054-.514a1.271 1.271 0 0 0-.173-.426.901.901 0 0 0-.309-.291.917.917 0 0 0-.46-.108zm6.486 0a.925.925 0 0 0-.462.108.913.913 0 0 0-.313.29 1.27 1.27 0 0 0-.175.427 2.39 2.39 0 0 0-.053.514c0 .181.017.353.053.517.036.164.095.307.175.43a.899.899 0 0 0 .313.297c.127.073.281.11.462.11.18 0 .334-.037.46-.11a.897.897 0 0 0 .31-.296c.078-.124.136-.267.172-.431.036-.164.054-.336.054-.517 0-.18-.018-.352-.054-.514a1.271 1.271 0 0 0-.173-.426.901.901 0 0 0-.308-.291.916.916 0 0 0-.461-.108zm-8.537.068l-.84.618.313.43.476-.368v1.877h.603v-2.557zm6.486 0l-.841.618.314.43.477-.368v1.877h.603v-2.557zm-4.435.445c.08 0 .143.028.193.084.05.057.087.127.114.21.026.083.044.173.054.269a2.541 2.541 0 0 1 0 .533c-.01.097-.028.187-.054.27a.584.584 0 0 1-.114.21.243.243 0 0 1-.193.085.248.248 0 0 1-.195-.086.584.584 0 0 1-.118-.209 1.245 1.245 0 0 1-.056-.27 2.645 2.645 0 0 1 0-.533c.01-.096.029-.186.056-.27a.583.583 0 0 1 .118-.209.25.25 0 0 1 .195-.084zm6.486 0c.08 0 .144.028.193.084.05.057.087.127.114.21.027.083.044.173.054.269a2.541 2.541 0 0 1 0 .533c-.01.097-.027.187-.054.27a.584.584 0 0 1-.114.21.243.243 0 0 1-.193.085.249.249 0 0 1-.195-.086.581.581 0 0 1-.117-.209 1.245 1.245 0 0 1-.056-.27 2.642 2.642 0 0 1 0-.533c.01-.096.028-.186.056-.27a.58.58 0 0 1 .117-.209.25.25 0 0 1 .195-.084zm-2.191 3.51a.93.93 0 0 0-.463.109.908.908 0 0 0-.312.291c-.08.122-.139.263-.175.426a2.383 2.383 0 0 0-.054.514c0 .18.018.353.054.516.036.164.094.308.175.432a.91.91 0 0 0 .312.296.92.92 0 0 0 .463.11c.18 0 .333-.037.46-.11a.892.892 0 0 0 .308-.296 1.32 1.32 0 0 0 .174-.432c.036-.163.054-.335.054-.516 0-.18-.018-.352-.054-.514a1.274 1.274 0 0 0-.174-.426.89.89 0 0 0-.309-.291.918.918 0 0 0-.46-.108zm-6.402.07l-.841.617.314.43.476-.369v1.878h.604v-2.557zm2.125 0l-.841.617.314.43.477-.369v1.878h.603v-2.557zm2.116 0l-.84.617.313.43.477-.369v1.878h.603v-2.557zm2.16.443c.08 0 .144.028.194.085a.605.605 0 0 1 .114.21c.026.083.044.172.053.269a2.639 2.639 0 0 1 0 .532 1.28 1.28 0 0 1-.053.27.585.585 0 0 1-.114.21.244.244 0 0 1-.193.085.25.25 0 0 1-.196-.085.589.589 0 0 1-.117-.21 1.245 1.245 0 0 1-.056-.27 2.597 2.597 0 0 1 0-.532c.01-.097.028-.186.056-.27a.589.589 0 0 1 .117-.209.249.249 0 0 1 .196-.085zm-6.729 3.073a.676.676 0 0 0-.335.078.661.661 0 0 0-.227.211.91.91 0 0 0-.127.31c-.027.118-.04.242-.04.373s.013.256.04.375a.93.93 0 0 0 .127.313.65.65 0 0 0 .227.215c.092.053.204.08.335.08a.655.655 0 0 0 .334-.08.65.65 0 0 0 .225-.215c.057-.09.1-.194.125-.313a1.75 1.75 0 0 0 .04-.375c0-.13-.014-.255-.04-.373a.931.931 0 0 0-.125-.31.658.658 0 0 0-.225-.21.667.667 0 0 0-.334-.08zm3.086 0a.675.675 0 0 0-.336.078.661.661 0 0 0-.226.211.907.907 0 0 0-.127.31 1.69 1.69 0 0 0-.04.373c0 .131.013.256.04.375a.928.928 0 0 0 .127.313c.058.09.134.162.226.215.093.053.205.08.336.08a.655.655 0 0 0 .334-.08.65.65 0 0 0 .224-.215c.058-.09.1-.194.126-.313a1.752 1.752 0 0 0 0-.748.94.94 0 0 0-.126-.31.657.657 0 0 0-.224-.21.667.667 0 0 0-.334-.08zm5.108 0a.675.675 0 0 0-.336.078.661.661 0 0 0-.226.211.91.91 0 0 0-.127.31c-.027.118-.04.242-.04.373s.013.256.04.375a.931.931 0 0 0 .127.313c.058.09.134.162.226.215.093.053.205.08.336.08.13 0 .243-.027.334-.08a.65.65 0 0 0 .224-.215c.058-.09.1-.194.126-.313a1.75 1.75 0 0 0 .04-.375c0-.13-.014-.255-.04-.373a.943.943 0 0 0-.126-.31.657.657 0 0 0-.224-.21.668.668 0 0 0-.334-.08zm-6.658.05l-.61.448.227.311.346-.266v1.362h.438v-1.856zm3.068 0l-.61.448.227.311.346-.266v1.362h.438v-1.856zm5.108 0l-.611.448.228.311.346-.266v1.362h.438v-1.856zm-9.712.322c.058 0 .105.02.14.062a.421.421 0 0 1 .083.151.96.96 0 0 1 .04.196 1.932 1.932 0 0 1 0 .386.954.954 0 0 1-.04.197.421.421 0 0 1-.083.152.176.176 0 0 1-.14.061.18.18 0 0 1-.141-.06.427.427 0 0 1-.085-.153.887.887 0 0 1-.041-.197 1.96 1.96 0 0 1 0-.386.893.893 0 0 1 .04-.196.42.42 0 0 1 .086-.151.181.181 0 0 1 .141-.062zm3.086 0c.058 0 .104.02.14.062a.421.421 0 0 1 .082.151.94.94 0 0 1 .04.196 1.906 1.906 0 0 1 0 .386.93.93 0 0 1-.04.197.421.421 0 0 1-.082.152.176.176 0 0 1-.14.061.18.18 0 0 1-.141-.06.42.42 0 0 1-.086-.153.846.846 0 0 1-.04-.197 1.965 1.965 0 0 1-.011-.195c0-.057.004-.121.01-.191a.849.849 0 0 1 .041-.196.42.42 0 0 1 .086-.151.182.182 0 0 1 .141-.062zm5.108 0c.058 0 .104.02.14.062a.421.421 0 0 1 .082.151.92.92 0 0 1 .04.196 1.963 1.963 0 0 1 0 .386.943.943 0 0 1-.04.197.421.421 0 0 1-.082.152.177.177 0 0 1-.14.061.18.18 0 0 1-.142-.06.437.437 0 0 1-.085-.153.95.95 0 0 1-.04-.197 1.965 1.965 0 0 1-.011-.195c0-.057.004-.121.01-.191a.959.959 0 0 1 .04-.196.47.47 0 0 1 .086-.151.181.181 0 0 1 .142-.062zm-1.684 1.814a.675.675 0 0 0-.336.079.66.66 0 0 0-.227.21.91.91 0 0 0-.127.31 1.731 1.731 0 0 0 0 .748.939.939 0 0 0 .127.314c.059.09.134.162.227.215.093.053.205.08.336.08a.66.66 0 0 0 .334-.08.648.648 0 0 0 .224-.215c.058-.09.1-.195.126-.314a1.737 1.737 0 0 0-.001-.747.928.928 0 0 0-.125-.31.65.65 0 0 0-.224-.211.668.668 0 0 0-.334-.079zm3.063 0a.676.676 0 0 0-.336.079.664.664 0 0 0-.227.21.906.906 0 0 0-.127.31 1.74 1.74 0 0 0 0 .748.936.936 0 0 0 .127.314.66.66 0 0 0 .227.215c.092.053.204.08.336.08a.654.654 0 0 0 .334-.08.648.648 0 0 0 .223-.215c.058-.09.1-.195.126-.314a1.74 1.74 0 0 0 0-.747.928.928 0 0 0-.126-.31.65.65 0 0 0-.223-.211.666.666 0 0 0-.334-.079zm-1.545.05l-.611.448.228.312.346-.267v1.363h.438v-1.856zm-1.518.323c.057 0 .104.02.14.061a.42.42 0 0 1 .082.152.91.91 0 0 1 .04.195 1.966 1.966 0 0 1 0 .387.951.951 0 0 1-.04.197.421.421 0 0 1-.082.152.177.177 0 0 1-.14.06.18.18 0 0 1-.142-.06.428.428 0 0 1-.085-.152.914.914 0 0 1-.04-.197 1.96 1.96 0 0 1-.011-.195c0-.058.003-.122.01-.192a.923.923 0 0 1 .041-.195c.02-.06.048-.11.085-.152a.181.181 0 0 1 .142-.061zm3.063 0c.057 0 .104.02.14.061a.42.42 0 0 1 .082.152.94.94 0 0 1 .04.195 1.91 1.91 0 0 1 0 .387.93.93 0 0 1-.04.197.422.422 0 0 1-.083.152.175.175 0 0 1-.14.06.18.18 0 0 1-.141-.06.423.423 0 0 1-.085-.152.907.907 0 0 1-.04-.197 1.95 1.95 0 0 1 0-.387.915.915 0 0 1 .04-.195c.02-.06.048-.11.085-.152a.182.182 0 0 1 .142-.061zm-9.713.185a.465.465 0 0 0-.232.055.456.456 0 0 0-.157.146.627.627 0 0 0-.089.215 1.168 1.168 0 0 0-.027.259c0 .09.009.177.027.26a.648.648 0 0 0 .089.216c.04.063.093.112.157.149a.459.459 0 0 0 .232.056c.09 0 .168-.02.231-.056a.45.45 0 0 0 .156-.149.67.67 0 0 0 .087-.217 1.218 1.218 0 0 0 0-.518.647.647 0 0 0-.087-.215.448.448 0 0 0-.156-.146.458.458 0 0 0-.23-.055zm1.052.035l-.423.31.158.217.24-.185v.944h.303v-1.286zm-1.052.224c.04 0 .073.014.097.042a.284.284 0 0 1 .057.105.69.69 0 0 1 .028.136c.004.049.007.092.007.133 0 .04-.003.086-.007.135a.684.684 0 0 1-.028.136.285.285 0 0 1-.057.105.123.123 0 0 1-.097.043.125.125 0 0 1-.098-.043.298.298 0 0 1-.059-.105.612.612 0 0 1-.028-.136 1.39 1.39 0 0 1 0-.268.62.62 0 0 1 .028-.136.297.297 0 0 1 .06-.105.125.125 0 0 1 .097-.042zm3.775 1.394a.463.463 0 0 0-.232.054.452.452 0 0 0-.157.146.621.621 0 0 0-.088.214 1.19 1.19 0 0 0 0 .519.641.641 0 0 0 .088.217.46.46 0 0 0 .157.15.458.458 0 0 0 .232.054.454.454 0 0 0 .232-.055.45.45 0 0 0 .155-.149.664.664 0 0 0 .087-.217 1.189 1.189 0 0 0 0-.519.642.642 0 0 0-.087-.214.446.446 0 0 0-.155-.146.459.459 0 0 0-.232-.054zm1.052.034l-.423.31.158.216.24-.185v.945h.303V22.68zm-1.052.223c.04 0 .073.014.098.043a.3.3 0 0 1 .057.105.643.643 0 0 1 .027.135 1.31 1.31 0 0 1 0 .268.654.654 0 0 1-.027.137.307.307 0 0 1-.057.105.124.124 0 0 1-.098.042.125.125 0 0 1-.098-.042.293.293 0 0 1-.059-.105.618.618 0 0 1-.028-.137 1.364 1.364 0 0 1 0-.268.612.612 0 0 1 .028-.135.287.287 0 0 1 .06-.105.123.123 0 0 1 .097-.043z"></path>
        </svg>
    </a>




    <a target="_blank" class="social" href="https://instagram.com/whokilleddb">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9S287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7s74.7 33.5 74.7 74.7s-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8c-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8s26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9c-26.2-26.2-58-34.4-93.9-36.2c-37-2.1-147.9-2.1-184.9 0c-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9c1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0c35.9-1.7 67.7-9.9 93.9-36.2c26.2-26.2 34.4-58 36.2-93.9c2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6c-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6c-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6c29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6c11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/>
        </svg>
    </a>



        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2023 . All rights reserved.
</p>

  </div>
</aside>

        <main class="content container">
            <div class="post">
  <div class="info">
    <h1 class="post-title">
        <a href="https://whokilleddb.github.io/blogs/posts/heavens-gate-and-the-tale-of-segments/">Heaven&#39;s Gate and the tale of Segments</a>
    </h1>
    <time datetime="2023-05-10T00:58:45&#43;0530" class="post-date">
        May 10, 2023
    </time>
    
    
    
    
    
    
</div>

  <h2 id="remember-heavens-gate-not-the-kris-kristofferson-movie">Remember Heaven&rsquo;s Gate? (not the Kris Kristofferson movie)</h2>
<p>I am pretty sure that most intermediate malware developer&rsquo;s/red-teamers know of <a href="https://encyclopedia.kaspersky.com/glossary/heavens-gate/">Heaven&rsquo;s Gate</a>, an age-old technique that malware authors leverage to run 64-bit code from 32-bit processes using <code>Wow64</code>, which emulates a 32-bit system on 64-bit machines (if you are not familiar with it, I HIGHLY recommend reading on it first). The system creates a 64-bit process and creates a 32-bit environment, inside which the 32-bit program runs.</p>
<p>For example, note the implementation of <code>NtOpenFile</code> on x64 systems. Notice how the function makes a <code>syscall</code>?</p>
<p><img src="/blogs/images/heavens-gate/ntopenfile64.png" alt="64 bit implementation on NtOpenFile"></p>
<p>Meanwhile, looking at the 32-bit implementation of the same, notice how there are no <code>syscall</code> instructions? Rather, it is calling some other function (also see that <code>0x33</code>? In a way, this blog is all about that!)</p>
<p><img src="/blogs/images/heavens-gate/ntopenfile32.png" alt="32 bit implementation on NtOpenFile"></p>
<p>Now, <strong>Heaven&rsquo;s Gate</strong> technique did receive a solid punch-in-the-gut when Windows 10 introduced Control-Flow-Guard(CFG) but hackers came back stronger (see <a href="https://www.youtube.com/watch?v=OuN2jgre-3o">Sheng-Hao Ma&rsquo;s  HITB Talk</a>)</p>
<p>However, the main thing I want to talk about in this blog is how the segmentation register comes into all of this with the whole <em>&ldquo;0x33-for-64-0x23-for-32 stuff&rdquo;</em> (if you have read through Heaven&rsquo;s Gate, you know what I am talking about). Initially, I found it very confusing, so, this is my attempt to break the thing down for my fellow security researchers struggling with the same!</p>
<h2 id="a-much-needed-glossary-of-terms">(A much-needed) Glossary of Terms</h2>
<p>Before we proceed, we need to define certain terms which will keep reappearing throughout the blog. The below table, taken from <a href="https://wiki.osdev.org/GDT_Tutorial">OSDev Wiki</a> and some other related terms:</p>
<table>
<thead>
<tr>
<th>Term</th>
<th>What the ðŸ¦† it means</th>
</tr>
</thead>
<tbody>
<tr>
<td>Segment</td>
<td>A logically contiguous chunk of memory with consistent properties (from the CPU&rsquo;s perspective)</td>
</tr>
<tr>
<td>Segment Register</td>
<td>A register of your CPU that refers to a segment for a particular purpose (<strong>CS</strong>,Â <strong>DS</strong>,Â <strong>SS</strong>,Â <strong>ES</strong>) or for general use (<strong>FS</strong>,Â <strong>GS</strong>)</td>
</tr>
<tr>
<td>Code Segment (CS)</td>
<td>This segment is used for storing executable code. When the CPU executes an instruction, it reads the code from the memory pointed to by the CS segment register.</td>
</tr>
<tr>
<td>Data Segment (DS)</td>
<td>This segment is used for storing data that is accessed by the program. For example, variables and arrays are typically stored in the DS segment.</td>
</tr>
<tr>
<td>Stack Segment (SS)</td>
<td>This segment is used for storing the program stack, which is used to manage function calls and local variables. The stack grows downwards from the end of the segment.</td>
</tr>
<tr>
<td>Extra Segment (ES)</td>
<td>This segment is an additional data segment that can be used by the program.</td>
</tr>
<tr>
<td>FS/GS Segments</td>
<td>This segment is an additional data segment that was originally intended to provide thread-local storage.</td>
</tr>
<tr>
<td>Segment Selector</td>
<td>A Segment Selector is a 16-bit binary data structure specific to the IA-32 and x86-64 architectures. It is used in Protected Mode and Long Mode. Its value identifies a segment in either the GDT or an LDT. It contains three fields and is used in a variety of situations to interact with Segmentation.</td>
</tr>
<tr>
<td>Segment Descriptor</td>
<td>An entry in a descriptor table. These are a binary data structure that tells the CPU the attributes of a given segment.</td>
</tr>
<tr>
<td>Global Descriptor Table (GDT)</td>
<td>The GDT is a data structure that is used by Intel x86-family for defining the characteristics of the various segments like the size, the base address, and access privileges like write and executable.</td>
</tr>
<tr>
<td>GDTR</td>
<td>TheÂ GDTÂ is pointed to by the value in theÂ GDTRÂ register. This is loaded using theÂ LGDTÂ assembly instruction, whose argument is a pointer to aÂ GDT DescriptorÂ structure</td>
</tr>
</tbody>
</table>
<p><em>Phew! Those are a lot of definitions</em></p>
<p><img src="https://media.tenor.com/FVL2P5gxMnAAAAAC/phew-close.gif" alt=""></p>
<p>Side Note: If all of this sounds complicated and too much to unpack, I would suggest just try to understand what <code>segments</code> and <code>segment selectors</code> are, and we should be good for a while!</p>
<h2 id="what-is-the-deal-with-0x230x33-segment-selectors-anyway">What is the deal with 0x23/0x33 Segment Selectors anyway?</h2>
<p>Remember the little <code>0x33</code> we spotted earlier in the 32-bit implementation of <code>NtOpenFile</code> in <code>ntdll.dll</code>? It essentially allows us to switch modes into 64-bit  mode.</p>
<p>But how does the whole thing work behind the hood? Where does this whole <em>&quot;<code>0x33</code> for 64-bit and <code>0x23</code> for 32-bit&quot;</em> narrative come from?</p>
<p>To answer that, we need to look into the GDT a bit. <a href="https://en.wikipedia.org/wiki/Global_Descriptor_Table#Description">Wikipedia</a> introduces GDT as:</p>
<blockquote>
<p>The GDT is a table of 8-byte entries. Each entry may refer to aÂ segment descriptor,Â Task State Segment(TSS),Â Local Descriptor TableÂ (LDT), orÂ call gate.</p>
</blockquote>
<p>The same article also mentions the following:</p>
<blockquote>
<p>In order to reference a segment, a program must use its index inside the GDT or the LDT. Such an index is called aÂ segment selectorÂ (or selector). The selector must be loaded into aÂ segment register to be used.</p>
</blockquote>
<p>The part we would be focusing on is the <code>segment descriptor</code> part of the definition.</p>
<h3 id="segment-descriptors">Segment Descriptors</h3>
<p>The x86 and x86-64 <code>segment descriptor</code> has the following form (<a href="https://en.wikipedia.org/wiki/Segment_descriptor#Structure">source</a>):</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0a/SegmentDescriptor.svg/870px-SegmentDescriptor.svg.png" alt=""></p>
<p>The important parts we need to consider here are:</p>
<ul>
<li><strong>Limit</strong>: 1.  The segment limit which specifies the segment size</li>
<li><strong>G=Granularity</strong>: If clear, the limit is in units of bytes, with a maximum of 2^20Â bytes. If set, the limit is in units of 4096-byte pages, for a maximum of 2^32Â bytes.</li>
<li><strong>D/B</strong>:
<ul>
<li><strong>D = Default</strong> operand size: If clear, this is a 16-bit code segment; if set, this is a 32-bit segment.</li>
<li><strong>B = Big</strong>: If set, the maximum offset size for a data segment is increased to 32-bit 0xffffffff. Otherwise, it&rsquo;s the 16-bit max 0x0000ffff. Essentially the same meaning as &ldquo;D&rdquo;.</li>
</ul>
</li>
<li><strong>L=Long</strong>: If set, this is a 64-bit segment (and D must be zero), and code in this segment uses the 64-bit instruction encoding. &ldquo;L&rdquo; cannot be set at the same time as &ldquo;D&rdquo; aka &ldquo;B&rdquo;. (Bit 21 in the image)</li>
<li><strong>AVL=Available</strong>: For software use, not used by hardware (Bit 20 in the image with the label A)</li>
<li><strong>P=Present</strong>: If clear, a <em>&ldquo;segment not present&rdquo;</em> exception is generated on any reference to this segment</li>
<li><strong>DPL=Descriptor privilege level</strong>: Privilege level (ring) required to access this descriptor</li>
</ul>
<p>From this, we can presume the values of some fields for the time when we are in 64-bit land:</p>
<ul>
<li>The <strong>Long bit flag</strong> must be set to <strong>1</strong> while the <strong>D/B bit</strong> must be unset.</li>
<li>The <strong>Granularity flag</strong> must be set for 32-bit (because it can only address a limited amount of memory) and unset for 64-bit memory</li>
<li>The <strong>Limit</strong> must be 0 for 64-bit (because it can address 2^64 bytes, aka 16 Exabytes of memory) while it must be set to <strong>0xFFFFFFF</strong> for 32-bit (because it can address only 2^32, aka 4Â GB of memory)</li>
</ul>
<h3 id="getting-things-real-for-a-moment">Getting things real for a moment</h3>
<p>In real mode, only 16-bit register values are used, yet a CPU can address up to 1Â MB of physical memory, how? When in real mode, memory is divided into segments, and each segment is 64Â KB in size. The CPU generates a physical address by combining a 16-bit segment value with a 16-bit offset value, i.e, the segment register is multiplied by 16 (shifted left by 4 bits) and then added to the address to give a 20-bit address and allowing the whole 1 MB of memory to be accessed.</p>
<p>However, whenever the system kicks into Protected Mode, the segment register starts behaving differently. It acts like a selector which is split up into the following parts:
<img src="http://ece-research.unm.edu/jimp/310/slides/micro_arch2-6.gif" alt="Segment Registers in Protected Mode"></p>
<ul>
<li>
<p><strong>Descriptor Index and Table Index (TI)</strong>Â :</p>
<ul>
<li>
<p>The 13 bit descriptor index selects one of up to 8K descriptors in either the GDT and LDT, as specified by the TI bit.</p>
</li>
<li>
<p><em>Therefore, these 14 bits allows access to 16K 8-byte descriptors.</em></p>
</li>
</ul>
</li>
<li>
<p><strong>RPL</strong>Â :</p>
<ul>
<li>The desired privilege level of the program.</li>
<li>Access is granted if the RPL value is lower (higher in privilege) than the AR of the segment. Otherwise, a privilege violation is issued.</li>
</ul>
</li>
</ul>
<p>So when we see something code like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">call</span> <span style="color:#ae81ff">0x33</span>:<span style="color:#66d9ef">address</span>
</span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">call</span> <span style="color:#ae81ff">0x23</span>:<span style="color:#66d9ef">address</span>
</span></span></code></pre></div><p>It means that the selector bits are changing. Looking at the <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/segment.h?id=5e857ce6eae7ca21b2055cca4885545e29228fe2#n176">Linux kernel source</a> (to the people who thought this was just related to Windows: pat-pat kiddo, you might want to start over again), we see that the default selector value for 32-bit is <strong>4</strong> and for 64-bit it is <strong>6</strong>.</p>
<p>Therefore,</p>
<ul>
<li>For 32-bit the register value becomes: <code>0000000000100</code> (4 for the selector value) + <code>0</code> (because we are using the GDT) + <code>11</code> (which means we are in ring 3) = <code>0000000000100011</code> = 35 = 0x23</li>
<li>For 64-bit the register value becomes: <code>0000000000110</code> (6 for the selector value) + <code>0</code> (because we are using the GDT) + <code>11</code> (which means we are in ring 3) = <code>0000000000110011</code> = 51 = 0x33</li>
</ul>
<p>So now we know where those <code>0x23</code> and <code>0x33</code> come from, but then again, why did we have to choose the selector values of <strong>4</strong> for 32-bit and <strong>6</strong> for 64-bit?</p>
<p>Well, the GDT has 2^13 = 8192 entries corresponding to the 13-bit selector. Out of which, entries 4 and 6 correspond to the following values:</p>
<p><strong>Entry 4</strong></p>
<p><img src="/blogs/images/heavens-gate/entry_4_0x23.png" alt="Entry 4 of GDT"></p>
<p><strong>Entry 6</strong>
<img src="/blogs/images/heavens-gate/entry_6_0x33.png" alt="Entry 6 of GDT"></p>
<p>Remember when we talked about <a href="#what-is-the-deal-with-0x230x33-segment-selectors-anyway">Segment Descriptors</a>, we theorized the values for the <strong>Flags</strong> and the <strong>Limits</strong> for 32-bit mode and 64-bit mode?</p>
<ul>
<li>
<p>Note how the <strong>Limit</strong> value is 0 for 64-bit and <strong>0xFFFFFFFF</strong> for 32-bit, as expected?</p>
</li>
<li>
<p>Looking at the flags, the <code>fb</code> part stands for the access bytes but the <strong>c</strong> for 32-bit and <strong>2</strong> for 64-bit can be imagined as:</p>
<p><img src="https://www.malwaretech.com/wp-content/uploads/2014/02/Flags-x86-x64.png" alt=""></p>
</li>
<li>
<p>Therefore,</p>
<ul>
<li>For 32 bit we see the <strong>Granularity</strong> and <strong>D/B</strong> flags set, as expected.</li>
<li>For 64-bit, we see the <strong>Long flag</strong> set as we had previously theorized</li>
</ul>
</li>
</ul>
<p>Therefore, we can now see that the <strong>4</strong> and the <strong>6</strong> correspond to these respective entries in the <strong>GDT</strong> for 32-bit and 64-bit respectively.  Therefore, even if the <code>segment descriptor</code> points to the same address, the selector determines in which mode the CPU executes it. As <a href="https://www.malwaretech.com/author/">Marcus Hutchins</a> puts it:</p>
<blockquote>
<p>Â So there you have it, both segment descriptors point to exactly the same address, the only difference is then when the 0x33 (64-bit) selector is set, the CPU will execute code in 64-bit mode. The selector is not magic and doesnâ€™t tell windows how to interpret the code, itâ€™s actually makes use of a CPU feature that allows the CPU to easily be switched between x86 and x64 mode using the GDT.</p>
</blockquote>
<h2 id="closing-words">Closing Words</h2>
<p>This blog was focused on a very small part of a well-known technique used by malware authors. The main motivation behind this was to understand the low-level mechanisms which make these techniques possible, and to have more in-depth knowledge about the magic which happens under the hood. Till next time, <strong>Happy Hacking!</strong></p>
<p><img src="https://media.tenor.com/ofYCY_OJQ1kAAAAd/hacker-hack.gif" alt=""></p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://s.itho.me/ccms_slides/2021/5/13/a23144e3-4313-4b9b-89c2-985fb3832b4e.pdf">Rebuild The Heaven&rsquo;s Gate: from 32-bit Hell back to 64-bit Wonderland - Sheng-Hao Ma</a></li>
<li><a href="https://en.wikipedia.org/wiki/Segment_descriptor#Structure">Segment descriptor</a></li>
<li><a href="http://ece-research.unm.edu/jimp/310/slides/micro_arch2.html">Protected Mode Memory Addressing</a></li>
<li><a href="https://www.malwarebytes.com/blog/news/2018/01/a-coin-miner-with-a-heavens-gate">A coin miner with a &ldquo;Heaven&rsquo;s Gate&rdquo;</a></li>
<li><a href="https://www.malwaretech.com/2014/02/the-0x33-segment-selector-heavens-gate.html">The 0x33 Segment Selector (Heavens Gate)</a></li>
</ul>

  <hr>
<div class="footer">
    
	    
            
	            <a class="previous-post" href="https://whokilleddb.github.io/blogs/posts/uefi-jungle/?ref=footer">Â« UEFI Jungle</a>
	        
        
	    
    
</div>

  <div class="article-toc " >
    <h4></h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#remember-heavens-gate-not-the-kris-kristofferson-movie">Remember Heaven&rsquo;s Gate? (not the Kris Kristofferson movie)</a></li>
    <li><a href="#a-much-needed-glossary-of-terms">(A much-needed) Glossary of Terms</a></li>
    <li><a href="#what-is-the-deal-with-0x230x33-segment-selectors-anyway">What is the deal with 0x23/0x33 Segment Selectors anyway?</a>
      <ul>
        <li><a href="#segment-descriptors">Segment Descriptors</a></li>
        <li><a href="#getting-things-real-for-a-moment">Getting things real for a moment</a></li>
      </ul>
    </li>
    <li><a href="#closing-words">Closing Words</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
</div>

</div>
        </main>
    </body>
</html>
